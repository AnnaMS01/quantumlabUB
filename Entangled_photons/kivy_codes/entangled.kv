
#:import math math
#:import Factory kivy.factory.Factory
#:kivy 1.10.0

<TrueScreen>:
    orientation: 'vertical'


<EntangledScreen>:
    name: 'ES'
    #Qua variables

    n_label: n_label #MOLT IMPORTANT AIXÒ, SI NO EL PROGRAMA NO SAP DE Q ÉS
    label_s1:label_s1
    label_s2:label_s2
    table_checkbox:table_checkbox
    graph_checkbox:graph
    s_label:s_label
    delete_button:delete_button
    select_button:select_button
    clear_btn:clear_btn
    plot_btn:plot_btn
    b1_label:b1_label
    b2_label:b2_label
    img_widg:anwidg

    #HVT variables

    n_label_hvt : n_label_hvt
    label_s1_hvt : label_s1_hvt
    label_s2_hvt : label_s2_hvt
    table_checkbox_hvt : table_checkbox_hvt
    s_label_hvt : s_label_hvt
    plot_btn_hvt : plot_btn_hvt
    alpha_hvt : alpha_hvt
    reps : reps
    rho1 : rho1
    rho2 : rho2

    BoxLayout:

        orientation: "vertical"
        padding: 10
        spacing: 5

        GridLayout:
            cols : 3
            rows : 1
            width: self.minimum_width
            BoxLayout:
                spacing: 10
                orientation: "vertical"
                Label:
                    text: "Pol 1"
                    size_hint: (0.05,0.1)
                    pos_hint:{'x': 0.32, 'y':1}
                    color: 1, 1, 1, 1
                Image:
                    id: I1
                    pos_hint:{'x': 0., 'y':0.}
                    source: 'img/pol2.png'

                # Giving the size of image
                    size_hint: (0.7,0.7)

                    # allow sterching of image
                    allow_stretch: False
                    canvas.before:
                        PushMatrix:
                        Rotate:
                            angle: root.angle_1
                            origin:self.center
                    canvas.after:
                        PopMatrix

                Label:
                    text: "Pol 2"
                    size_hint: (0.05,0.1)
                    pos_hint:{'x': 0.32, 'y':1}
                    color: 1, 1, 1, 1

                Image:
                    id: I2
                    pos_hint:{'x': 0., 'y':0.}
                    source: 'img/pol2.png'

                # Giving the size of image
                    size_hint: (0.7,0.7)

                    # allow sterching of image
                    allow_stretch: False
                    canvas.before:
                        PushMatrix:
                        Rotate:
                            angle: root.angle_2
                            origin:self.center
                    canvas.after:
                        PopMatrix

            BoxLayout:
                id: anwidg
                canvas:
                    Color:
                        rgb: (1, 1, 1)
                    Rectangle:
                        size : self.size
                        pos: self.pos
                        source : "img/sketch_exp_6.png"

        TabbedPanel:
            size_hint: (1, 1)
            do_default_tab: False
            border : [0, 0, 0, 0]
            background_image: 'img/metal.jpg'

            TabbedPanelItem: #creem la primera pestanya
                text: "[b]Quantic\n experiment:[/b]"
                markup: True
                on_release: root.tab_selector = 0
                on_release: root.tab_change = True
                on_release: root.angle_1 = 0
                on_release: root.angle_2 = 0
                on_release: root.angle_update()

                BoxLayout:
                    orientation: "horizontal" #el partim en 2 cols grans

                    BoxLayout:
                        orientation:"vertical"
                        Label:
                            text: "[b]Experiment settings:[/b]"
                            markup: True
                        BoxLayout:
                            orientation: "horizontal"

                            Label:
                                text: "Number of photons:"
                                markup: True
                                pos_hint:{'x': .7, 'y':.3}

                            Button:
                                text:"-"
                                size_hint: (0.2,0.25)
                                pos_hint:{'x': 1.3, 'y':.7}
                                on_press: root.start_photon_adding(-10000)
                                on_press: root.add_photons(-10000)
                                on_release: root.stop_photon_adding()

                            TextInput:
                                id: n_label
                                size_hint: (.5,0.25)
                                pos_hint:{'x': 0.7, 'y':.7}
                                foreground_color : (1, 0, 0, 1)
                                background_color : (0, 0, 0, 1)
                                text: "10000"
                                font_name: 'digital-7.ttf'
                                font_size: 20
                                multiline : False


                            Button:
                                text: "+"
                                size_hint: (0.2,0.25)
                                pos_hint:{'x': .5, 'y':.7}
                                on_press: root.start_photon_adding(10000)
                                on_press: root.add_photons(10000)
                                on_release: root.stop_photon_adding()

                        FloatLayout:
                            Label:
                                id: s_label
                                size_hint: None, None
                                size:240,100
                                text:'[font=digital-7][color=000000][size=34] S=                [/color][/font][/size]'
                                markup:True
                                pos_hint:{'x':0.1,'y':0.2}
                                canvas:
                                canvas.before:
                                    Color:
                                        rgba: 0, 153, 0, 0.5

                                    RoundedRectangle:
                                        pos: self.pos[0] , self.pos[1]+20
                                        size: (self.width, self.height*0.8)
                                        id: S_rect

                    BoxLayout:
                        orientation:"vertical"
                        Label:
                            text:"[b]Polarizer angles:[/b]"
                            markup: True
                        Label:
                            text: "Angle of polarizer 1: \u03B1 (deg)"
                            pos_hint:{'x': 0, 'y':0}
                        AngleKnob:
                            pos_hint:{'x': 0.4, 'y':.7}
                            min: 0
                            max: 360
                            step: 1
                            slope: 1
                            value: 0
                            on_release: root.runexp()
                            on_release: root.run_animation()
                            on_press: root.change_pol_angles()
                            on_release: root.stop_angles()
                            knobimg_source: "img/knob_metal.png"
                            show_marker: True  # Show surrounding marker
                            marker_img: "img/bline2.png" # Marker texture image

                            Label:
                                id: label_s1
                                text: "{}".format(int(self.parent.value))
                                center: self.parent.center
                                font_size: 20
                                color: 0.1, 0.1, 0.1, 1

                        Label:
                            text: "Angle of polarizer 2: \u03B2 (deg)"
                        AngleKnob:
                            pos_hint:{'x': 0.4, 'y':.7}
                            min: 0
                            max: 360
                            step: 1
                            slope: 1
                            value: 0
                            knobimg_source: "img/knob_metal.png"
                            show_marker: True  # Show surrounding marker
                            on_release: root.runexp()
                            on_release: root.run_animation()

                            on_press: root.change_pol_angles()
                            on_release: root.stop_angles()
                            marker_img: "img/bline2.png" # Marker texture image

                            Label:
                                id: label_s2
                                text: "{}".format(int(self.parent.value))
                                center: self.parent.center
                                font_size: 20
                                color: 0.1, 0.1, 0.1, 1

                    BoxLayout:
                        orientation:"vertical"
                        BoxLayout:
                            orientation: "vertical"
                            FloatLayout:
                                Switch:
                                    id: graph
                                    size_hint:(0.2,0.2)
                                    pos_hint:{'x': 0, 'y':0.4}
                                Label:
                                    text: "Generate 3D S-plot"
                                    pos_hint:{'x': -0.1, 'y':0}
                            BoxLayout:
                                orientation: "horizontal"
                                BoxLayout:
                                    orientation: "vertical"
                                    Button:
                                        id: select_button
                                        text: "Select angle"
                                        disabled: True
                                        on_release:root.select_angle()
                                    Button:
                                        id: delete_button
                                        disabled: True
                                        text: "Delete angle"
                                        on_release:root.delete_angle()
                                BoxLayout:
                                    orientation: "vertical"
                                    BoxLayout:
                                        orientation: "horizontal"
                                        Label:
                                            text:"\u03B2"+"1:"
                                        TextInput:
                                            id: b1_label
                                            size_hint: (1,1.25)
                                            foreground_color : (1, 0, 0, 1)
                                            background_color : (0, 0, 0, 1)
                                            text: '0'
                                            font_name: 'digital-7.ttf'
                                            font_size: 20
                                            multiline:False
                                            on_text:root.kwinput=True
                                            on_text_validate:root.select_angle()
                                            disabled: not graph.active

                                    BoxLayout:
                                        orientation: "horizontal"
                                        Label:
                                            text:"\u03B2"+"2:"
                                        TextInput:
                                            id: b2_label
                                            size_hint: (1,1.25)
                                            foreground_color : (1, 0, 0, 1)
                                            background_color : (0, 0, 0, 1)
                                            text: '0'
                                            font_name: 'digital-7.ttf'
                                            font_size: 20
                                            multiline:False
                                            on_text:root.kwinput=True
                                            on_text_validate:root.select_angle()
                                            disabled: not graph.active

                            BoxLayout:
                                orientation: "horizontal"
                                Button:
                                    id:plot_btn
                                    text: "Plot"
                                    size_hint: (0.9,0.7)
                                    disabled: True
                                    on_release: root.manager.get_screen('GS').get_graph()

                                Button:
                                    id:clear_btn
                                    text: "Clear"
                                    size_hint: (0.9,0.7)
                                    disabled: True
                                    on_release:root.clear_angles()
                        BoxLayout:
                            orientation: "horizontal"
                            FloatLayout:
                                Switch:
                                    id: table_checkbox
                                    size_hint:(0.1,0.1)
                                    pos_hint:{'x': 0, 'y':0.4}

                                Label:
                                    text: "Generate table"
                                    pos_hint:{'x': -0.1, 'y':0}

            TabbedPanelItem: #creem la 2a pestanya
                text: "[b]HVT[/b]"
                markup: True
                on_release : root.tab_selector = 1
                on_release: root.angle_1 = 0
                on_release: root.angle_2 = 0
                on_release: root.tab_change = True
                on_release: root.angle_update()
                BoxLayout:
                    orientation: "horizontal" #el partim en 2 cols grans

                    BoxLayout:
                        orientation:"vertical"
                        Label:
                            text: "[b]Experiment settings:[/b]"
                            markup: True
                        BoxLayout:
                            orientation: "horizontal"

                            Label:
                                text: "Number of photons:"
                                markup: True
                                pos_hint:{'x': .7, 'y':.3}

                            Button:
                                text:"-"
                                size_hint: (0.2,0.35)
                                pos_hint:{'x': 1.3, 'y':.7}
                                on_press: root.start_photon_adding(-10000)
                                on_press: root.add_photons(-10000)
                                on_release: root.stop_photon_adding()

                            TextInput:
                                id: n_label_hvt
                                size_hint: (.5,0.35)
                                pos_hint:{'x': 0.7, 'y':.7}
                                foreground_color : (1, 0, 0, 1)
                                background_color : (0, 0, 0, 1)
                                text: "10000"
                                font_name: 'digital-7.ttf'
                                font_size: 20
                                multiline : False


                            Button:
                                text: "+"
                                size_hint: (0.2,0.35)
                                pos_hint:{'x': .5, 'y':.7}
                                on_press: root.start_photon_adding(10000)
                                on_press: root.add_photons(10000)
                                on_release: root.stop_photon_adding()
                        BoxLayout:
                            orientation: "horizontal"
                            FloatLayout:
                                pos_hint:{'x': 0, 'y':.0}
                                Label:
                                    pos_hint:{'x': 0.1, 'y':.5}
                                    text: "Number of repetitions\n of the experiment:"

                            FloatLayout:
                                TextInput:
                                    id:reps
                                    background_color : (0, 0, 0, 1)
                                    foreground_color : (1, 0, 0, 1)
                                    size_hint: (0.4,.4)
                                    pos_hint : {'x': 0.3, 'y':.7}
                                    multiline : False
                                    text: '1'
                                    font_name: 'digital-7.ttf'
                                    font_size: 25

                        FloatLayout:
                            Label:
                                id: s_label_hvt
                                size_hint: None, None
                                size:240,100
                                text:'[font=digital-7][color=000000][size=34] S=                [/color][/font][/size]'
                                markup:True
                                pos_hint:{'x':0.2,'y':0.15}
                                canvas:
                                canvas.before:
                                    Color:
                                        rgba: 0, 153, 0, 0.5

                                    RoundedRectangle:
                                        pos: self.pos[0] , self.pos[1]+20
                                        size: (self.width, self.height*0.8)
                                        id: S_rect_hvt

                    BoxLayout:
                        orientation:"vertical"
                        Label:
                            text:"[b]Polarizer angles:[/b]"
                            markup: True
                        Label:
                            text: "Angle of polarizer 1: \u03B1 (deg)"
                            pos_hint:{'x': 0, 'y':0}
                        AngleKnob:
                            pos_hint:{'x': 0.4, 'y':.7}
                            min: 0
                            max: 360
                            step: 1
                            slope: 1
                            value: 0
                            on_press: root.change_pol_angles()
                            on_release: root.stop_angles()
                            knobimg_source: "img/knob_metal.png"
                            show_marker: True  # Show surrounding marker
                            marker_img: "img/bline2.png" # Marker texture image

                            Label:
                                id: label_s1_hvt
                                text: "{}".format(int(self.parent.value))
                                center: self.parent.center
                                font_size: 20
                                color: 0.1, 0.1, 0.1, 1

                        Label:
                            text: "Angle of polarizer 2: \u03B2 (deg)"
                        AngleKnob:
                            pos_hint:{'x': 0.4, 'y':.7}
                            min: 0
                            max: 360
                            step: 1
                            slope: 1
                            value: 0
                            knobimg_source: "img/knob_metal.png"
                            show_marker: True  # Show surrounding marker
                            on_press: root.change_pol_angles()
                            on_release: root.stop_angles()
                            marker_img: "img/bline2.png" # Marker texture image
                            #on_touch_up: root.runexp()

                            Label:
                                id: label_s2_hvt
                                text: "{}".format(int(self.parent.value))
                                center: self.parent.center
                                font_size: 20
                                color: 0.1, 0.1, 0.1, 1

                    BoxLayout:
                        orientation:"vertical"
                        BoxLayout:
                            orientation: "vertical"

                            Label:
                                text: "Generate S vs \u03B2 plot"
                                pos_hint:{'x': -0.1, 'y':0}
                            Label:
                                text:"select fixed \u03B1" + " (deg):"
                            BoxLayout:
                                orientation: "horizontal"

                                Button:
                                    id: rest_btn
                                    text: "-"
                                    on_press: root.angle_down_hvt()
                                    on_press: root.start_angle_down()
                                    on_release: root.stop_angle_down()

                                TextInput:
                                    id: alpha_hvt
                                    size_hint: (1,1.1)
                                    foreground_color : (1, 0, 0, 1)
                                    background_color : (0, 0, 0, 1)
                                    text: '0'
                                    font_name: 'digital-7.ttf'
                                    font_size: 20
                                    multiline : False
                                    on_text_validate:root.manager.get_screen('GS').get_graph()


                                Button:
                                    id: sum_btn
                                    text: "+"
                                    disabled: False
                                    on_press: root.angle_up_hvt()
                                    on_press: root.start_angle_up()
                                    on_release: root.stop_angle_up()


                            BoxLayout:
                                orientation: "horizontal"
                                Button:
                                    id:plot_btn_hvt
                                    text: "Plot"
                                    size_hint: (0.9,0.7)
                                    on_release: root.manager.get_screen('GS').get_graph()
                        BoxLayout:
                            orientation: "horizontal"
                            FloatLayout:
                                Switch:
                                    id: table_checkbox_hvt
                                    size_hint:(0.1,0.1)
                                    pos_hint:{'x': 0, 'y':0.4}

                                Label:
                                    text: "Generate table"
                                    pos_hint:{'x': -0.1, 'y':0}
                        BoxLayout:
                            orientation: "vertical"

                            BoxLayout:
                                orientation: "horizontal"
                                Switch:
                                    id: rho1
                                    active : True
                                Label:
                                    text: "\u03C1_1"
                            BoxLayout:
                                orientation: "horizontal"
                                Switch:
                                    id: rho2
                                Label:
                                    text: "\u03C1_2"


                        Button:
                            size_hint: (1,0.3)
                            text: "Calculate S"
                            id: run_b
                            on_release: root.runexp()
                            on_release: root.run_animation()

            TabbedPanelItem:
                text: "[b]Use real\n data[/b]"
                markup: True
                BoxLayout:
                    orientation: 'vertical'

                    FileChooserIconView:
                        id: filechooser
                        path: "."
                        on_submit: root.select_file(filechooser.selection)
                        on_selection:
                            if len(filechooser.selection) != 0: \
                            root.file_name = filechooser.selection[0]

                    Button:
                        size_hint: (1,0.1)
                        text: 'Load file (.csv)'
                        on_release:root.select_file(filechooser.selection)

            TabbedPanelItem:
                text: "[b]Experiment\n Sketch[/b]"
                markup: True

<GraphScreen>:
    mainlay:mainlay
    name:'GS'
    BoxLayout:
        orientation: 'vertical'
        id: mainlay


<TablePopup>:
    table_lay : table_lay
    title: 'Table 1'
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba : (1,1,1,1)
            Rectangle:
                size : self.size
                pos : self.pos

        GridLayout:
            id : table_lay
            rows : 17
            cols : 5

        Button:
            size_hint: (1,0.05)
            pos_hint: {'x':0, 'y':0}
            text: 'Close'
            on_release: root.manager.current = 'ES'

<DataScreen>:
    name: 'DS'
    table_lay_data: table_lay_data
    s_label_data : s_label_data
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba : (1,1,1,1)
            Rectangle:
                size : self.size
                pos : self.pos

        GridLayout:
            id : table_lay_data
            rows : 17
            cols : 5

        BoxLayout:
            orientation: 'vertical'
            size_hint: (1,0.2)
            BoxLayout:
                orientation: 'horizontal'
                BoxLayout:
                    orientation: 'vertical'
                    Button:
                        text: 'Calculate S from data'
                        on_release : root.run_exp_data()

                    Button:
                        text: 'Calculate S predicted by HVT'
                        on_release:  root.run_cla_pred()
                Label:
                    id: s_label_data
                    text:'[font=digital-7][color=000000][size=34] S=                [/color][/font][/size]'
                    markup:True
                    #pos_hint:{'x':0.1,'y':0.2}
                    canvas.before:
                        Color:
                            rgba: 0, 153, 0, 1

                        RoundedRectangle:
                            pos: self.pos[0] , self.pos[1]
                            size: (self.width, self.height)
                            id: S_rect

            Button:
                text: 'Close'
                on_release: root.manager.current = 'ES'
                on_release: s_label_data.text = '[font=digital-7][color=000000][size=34] S=                [/color][/font][/size]'